generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Product {
  id           Int                 @id @default(autoincrement())
  productCode  String              @unique @map("product_code")
  price        String
  sizes        String[]
  defaultSize  String?             @map("default_size")
  images       String[]
  isNew        Boolean             @default(false) @map("is_new")
  isRunners    Boolean             @default(false) @map("is_runners")
  inStock      Boolean             @default(true) @map("in_stock")
  source       ProductSource       @default(DEFAULT)
  sourceMeta   Json?               @map("source_meta")
  createdAt    DateTime            @default(now()) @map("created_at")
  updatedAt    DateTime            @updatedAt @map("updated_at")
  descriptions Description[]
  features     Feature[]
  collections  ProductCollection[]
  colors       ProductColor[]
  productNames ProductName[]
  styles       ProductStyle[]

  @@index([inStock])
  @@index([source])
  @@index([createdAt])
  @@map("products")
}

model ProductName {
  id        Int     @id @default(autoincrement())
  productId Int     @map("product_id")
  locale    String
  name      String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, locale])
  @@index([name])
  @@map("product_names")
}

model Description {
  id          Int     @id @default(autoincrement())
  productId   Int     @map("product_id")
  locale      String
  description String
  product     Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, locale])
  @@map("descriptions")
}

model Feature {
  id              Int      @id @default(autoincrement())
  productId       Int      @map("product_id")
  locale          String
  head            String
  careAndWarranty String[] @map("care_and_warranty")
  technicalInfo   String[] @map("technical_info")
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, locale])
  @@map("features")
}

model ProductColor {
  id        Int     @id @default(autoincrement())
  productId Int     @map("product_id")
  locale    String
  name      String
  value     String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, locale])
  @@map("product_colors")
}

model ProductCollection {
  id        Int     @id @default(autoincrement())
  productId Int     @map("product_id")
  locale    String
  name      String
  value     String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, locale])
  @@map("product_collections")
}

model ProductStyle {
  id        Int     @id @default(autoincrement())
  productId Int     @map("product_id")
  locale    String
  name      String
  value     String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, locale])
  @@map("product_styles")
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  name      String?
  role      UserRole @default(ADMIN)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}

enum UserRole {
  ADMIN
  SUPER_ADMIN
}

enum ProductSource {
  DEFAULT
  BMHOME
}

enum CatalogMode {
  AUTO
  DEFAULT_ONLY
  BMHOME_ONLY
  MERGE
}

enum BmhomeSyncStatus {
  RUNNING
  SUCCESS
  NEED_AUTH
  FAILED
}

model BmhomeSyncSettings {
  id                   Int         @id @default(1)
  catalogMode          CatalogMode @default(AUTO)
  autoFallbackMinCount Int         @default(1) @map("auto_fallback_min_count")
  feedUrl              String      @default("https://www.bmhome.com.tr/TicimaxXmlV2/7253FC19C30949458CFEA4A870C7779E/") @map("feed_url")
  usdToEurRate         Float       @default(1) @map("usd_to_eur_rate")
  createdAt            DateTime    @default(now()) @map("created_at")
  updatedAt            DateTime    @updatedAt @map("updated_at")

  @@map("bmhome_sync_settings")
}

model BmhomeSyncRun {
  id               Int              @id @default(autoincrement())
  status           BmhomeSyncStatus @default(RUNNING)
  startedAt        DateTime         @default(now()) @map("started_at")
  finishedAt       DateTime?        @map("finished_at")
  durationMs       Int?             @map("duration_ms")
  productsFound    Int              @default(0) @map("products_found")
  productsParsed   Int              @default(0) @map("products_parsed")
  variantsFound    Int              @default(0) @map("variants_found")
  variantsParsed   Int              @default(0) @map("variants_parsed")
  created          Int              @default(0)
  updated          Int              @default(0)
  unchanged        Int              @default(0)
  deactivated      Int              @default(0)
  hiddenNoPrice    Int              @default(0) @map("hidden_no_price")
  hiddenZeroPrice  Int              @default(0) @map("hidden_zero_price")
  errorsCount      Int              @default(0) @map("errors_count")
  priceChangedCount Int             @default(0) @map("price_changed_count")
  summaryRu        String?          @map("summary_ru")
  hintRu           String?          @map("hint_ru")
  reportDir        String?          @map("report_dir")
  reportJsonPath   String?          @map("report_json_path")
  reportMdPath     String?          @map("report_md_path")

  @@index([status, startedAt])
  @@map("bmhome_sync_runs")
}
